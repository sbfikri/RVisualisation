library(tidyverse)
library(readr)
library(gganimate)
library(gifski)
library(lubridate)
library(RColorBrewer)
library(scales)
library(transformr)


parkingViolation <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-12-03/tickets.csv")

#clean the data
averageHours <- parkingViolation %>% select(issue_datetime, fine, issuing_agency)

averageHours <- averageHours %>% 
  mutate(Hour = as.character(hour(averageHours$issue_datetime)),
         Month = as.POSIXct(averageHours$issue_datetime, label = TRUE)) %>%
  group_by(Hour, Month) %>% summarise(fine = mean(fine)) %>% ungroup()

averageHours$Hour <- as.integer(averageHours$Hour)


Loess <- loess(fine ~ Hour, averageHours)
Predict <- as.data.frame(c(predict(Loess)))
                     
colnames(Predict) <- "Predict"

averageHours <- cbind(averageHours, Predict)
averageHours$Month <- as.D(averageHours$Month, format = "%B")

glimpse(averageHours)


#visualisation
averageHours %>% ggplot(aes(x = Hour,
                            y = fine, color = fine
                            )) + geom_point(size = 3, 
                                            alpha = 0.8) +
  geom_line(aes(x = Hour, y = Predict), 
            color = "black", 
            linetype = "dashed",
            alpha = 1/3) +
  theme_bw(base_family = 'Georgia') + 
  scale_colour_gradient(low="#61f7ff", high="#ff6961") + scale_y_continuous(labels = dollar) +
  scale_x_continuous(breaks=c(0, 6, 12, 18, 23)) + 
  labs(x = "Hour", y = "", title = "{frame_time}") +
  transition_time(Month)
  


  